# 토스페이먼츠 결제 연동 가이드

## 개요

이 프로젝트에 토스페이먼츠 결제 시스템이 통합되어 있습니다. 카드 결제를 기본으로 지원하며, 추후 간편결제 및 가상계좌 확장이 가능한 구조로 설계되었습니다.

## 주요 기능

- ✅ 카드 결제 (기본)
- ✅ 가격 변조 방지 (서버에서 amount 검증)
- ✅ 결제 성공/실패 페이지
- ✅ 서버 결제 승인(confirm) 엔드포인트
- ✅ 웹훅 엔드포인트 + 서명 검증
- ✅ 멱등 처리 (중복 승인 방지)

## 프로젝트 구조

```
├── html/
│   ├── apply.html              # 강의 신청 페이지 (결제하기 버튼 포함)
│   └── pay/
│       ├── checkout.html        # 결제 페이지 (토스 위젯)
│       ├── success.html         # 결제 성공 페이지
│       └── fail.html            # 결제 실패 페이지
├── server.js                    # Express 서버 (결제 API 포함)
├── .env                         # 환경 변수 설정
└── .env.example                 # 환경 변수 예제
```

## 환경 변수 설정

### 1. `.env` 파일 생성

프로젝트 루트에 `.env` 파일을 생성하고 다음 변수들을 설정하세요:

```env
# Server Configuration
PORT=3000
APP_BASE_URL=http://localhost:3000

# Toss Payments Configuration
TOSS_SECRET_KEY=test_gsk_docs_OaPz8L5KdmQXkzRz3y47BMw6
TOSS_CLIENT_KEY=test_ck_D5GePWvyJnrK0W0k6q8gLzN97Eoq
TOSS_WEBHOOK_SECRET=your_webhook_secret_key
```

### 2. 테스트 키 발급

1. [토스페이먼츠 개발자 콘솔](https://developers.tosspayments.com/) 접속
2. 로그인 후 "내 상점" → "개발용 상점" 선택
3. "개발용 상점 관리" → "API 키" 메뉴에서 키 확인
   - 시크릿 키: `test_gsk_...` (서버 전용)
   - 클라이언트 키: `test_ck_...` (프론트엔드용)

### 3. 라이브 키로 전환 (운영 환경)

운영 환경에서는 라이브 키를 사용해야 합니다:

1. 토스페이먼츠 개발자 콘솔에서 "운영용 상점" 생성
2. 운영용 API 키 발급
3. `.env` 파일의 키를 라이브 키로 교체
4. `APP_BASE_URL`을 실제 도메인으로 변경

## API 엔드포인트

### 1. 주문 생성

**POST** `/api/payments/create-order`

**Request Body:**
```json
{
  "courseSlug": "marketing-ai",
  "courseTitle": "AI 마케팅 실무",
  "amount": 500000,
  "userId": "user@example.com"
}
```

**Response:**
```json
{
  "ok": true,
  "orderId": "order_1234567890_abc123",
  "amount": 500000,
  "orderName": "AI 마케팅 실무",
  "customerKey": "user@example.com"
}
```

### 2. 결제 승인

**POST** `/api/payments/confirm`

**Request Body:**
```json
{
  "paymentKey": "tgen_...",
  "orderId": "order_1234567890_abc123",
  "amount": 500000
}
```

**Response:**
```json
{
  "ok": true,
  "order": {
    "id": "order_1234567890_abc123",
    "orderName": "AI 마케팅 실무",
    "amount": 500000,
    "method": "카드",
    "createdAt": "2024-01-01T00:00:00.000Z"
  }
}
```

### 3. 웹훅

**POST** `/api/payments/webhook`

토스페이먼츠에서 결제 상태 변경 시 자동으로 호출됩니다.

## 결제 흐름

1. **신청 페이지** (`html/apply.html`)
   - 사용자가 과정을 선택하고 정보를 입력
   - 가격이 있는 경우 "결제하기" 버튼 표시
   - 클릭 시 주문 생성 API 호출

2. **결제 페이지** (`html/pay/checkout.html`)
   - 토스페이먼츠 위젯 렌더링
   - 사용자가 결제 정보 입력
   - "결제하기" 클릭 시 토스페이먼츠로 결제 요청

3. **결제 성공/실패 페이지**
   - 성공: `html/pay/success.html` → 결제 승인 API 호출
   - 실패: `html/pay/fail.html` → 오류 정보 표시

## 보안 체크리스트

- ✅ Secret key는 서버에서만 사용, 로그에 출력 금지
- ✅ Amount는 서버 DB 기준으로만 승인 (가격 변조 방지)
- ✅ OrderId는 추측 어려운 값(UUID) 사용
- ✅ 웹훅은 서명 검증 통과한 것만 신뢰
- ✅ 에러 메시지는 사용자에게 과도한 내부정보 노출 금지

## 로컬 테스트 절차

### 1. 환경 설정

```bash
# .env 파일 생성
cp .env.example .env

# .env 파일 편집하여 테스트 키 입력
# TOSS_SECRET_KEY=test_gsk_...
# TOSS_CLIENT_KEY=test_ck_...
```

### 2. 서버 실행

```bash
npm install
npm start
```

### 3. 테스트 결제

1. 브라우저에서 `http://localhost:3000/html/apply.html` 접속
2. 과정 선택 (가격이 설정된 과정)
3. 신청 정보 입력
4. "결제하기" 버튼 클릭
5. 결제 페이지에서 테스트 카드 정보 입력:
   - 카드번호: `1234-5678-9012-3456`
   - 유효기간: `12/34`
   - CVC: `123`
   - 비밀번호: `12**`
6. 결제 완료 확인

## 운영 배포 체크리스트

### 1. 환경 변수

- [ ] 라이브 Secret Key 설정
- [ ] 라이브 Client Key 설정
- [ ] `APP_BASE_URL`을 실제 도메인으로 변경
- [ ] 웹훅 Secret Key 설정

### 2. 리다이렉트 URL

- [ ] 성공 URL: `https://yourdomain.com/html/pay/success.html`
- [ ] 실패 URL: `https://yourdomain.com/html/pay/fail.html`
- [ ] 토스페이먼츠 콘솔에서 리다이렉트 URL 등록

### 3. 웹훅 설정

1. 토스페이먼츠 개발자 콘솔 접속
2. "웹훅" 메뉴에서 웹훅 URL 등록:
   - URL: `https://yourdomain.com/api/payments/webhook`
   - 이벤트: `PAYMENT_CONFIRMED`, `PAYMENT_FAILED`, `PAYMENT_CANCELED`
3. 웹훅 Secret Key 생성 및 `.env`에 설정

### 4. HTTPS

- [ ] 모든 결제 관련 통신은 HTTPS 필수
- [ ] SSL 인증서 설정 확인

### 5. 로그 마스킹

- [ ] Secret Key가 로그에 출력되지 않도록 확인
- [ ] 민감한 정보(카드번호 등) 로그 출력 금지

## 데이터베이스 연동 (선택사항)

현재는 메모리 기반 저장소를 사용하고 있습니다. 운영 환경에서는 데이터베이스를 사용하는 것을 권장합니다.

### Order 테이블 구조

```sql
CREATE TABLE orders (
  id VARCHAR(255) PRIMARY KEY,
  user_id VARCHAR(255),
  amount INT NOT NULL,
  currency VARCHAR(10) DEFAULT 'KRW',
  status VARCHAR(20) DEFAULT 'CREATED',
  payment_key VARCHAR(255),
  method VARCHAR(50),
  order_name VARCHAR(255),
  customer_key VARCHAR(255),
  raw_response JSON,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

## 문제 해결

### 결제 위젯이 로드되지 않음

- 클라이언트 키가 올바르게 설정되었는지 확인
- 브라우저 콘솔에서 오류 메시지 확인
- CORS 설정 확인

### 결제 승인 실패

- 서버 로그에서 오류 메시지 확인
- Secret Key가 올바른지 확인
- Amount 검증 실패 시 DB의 금액과 요청 금액 비교

### 웹훅이 동작하지 않음

- 웹훅 URL이 올바르게 등록되었는지 확인
- 서명 검증 로직 확인
- 서버 로그에서 웹훅 요청 확인

## 추가 기능 확장

### 간편결제 추가

토스페이먼츠 위젯에서 간편결제 옵션을 활성화하면 자동으로 지원됩니다.

### 가상계좌 추가

1. 토스페이먼츠 콘솔에서 가상계좌 결제 수단 활성화
2. 위젯 설정에서 가상계좌 옵션 추가
3. 웹훅에서 `PAYMENT_CONFIRMED` 이벤트 처리

## 참고 자료

- [토스페이먼츠 개발자 문서](https://docs.tosspayments.com/)
- [토스페이먼츠 API 레퍼런스](https://docs.tosspayments.com/reference)
- [토스페이먼츠 위젯 가이드](https://docs.tosspayments.com/guides/payment-widget)

## 문의

결제 관련 문의사항은 토스페이먼츠 고객센터(1588-6880) 또는 개발자 콘솔의 문의하기를 이용해주세요.

