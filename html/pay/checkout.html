<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>결제하기 | Irum Academy</title>

    <!-- CSS -->
    <link rel="stylesheet" href="../../css/main.css">
    <link rel="stylesheet" href="../../css/animations.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- Toss Payments Widget -->
    <script src="https://js.tosspayments.com/v1/payment-widget"></script>

    <style>
        .checkout-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }

        .order-summary {
            background: #f9fafb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .order-total {
            display: flex;
            justify-content: space-between;
            padding: 1rem 0;
            margin-top: 1rem;
            border-top: 2px solid #000;
            font-size: 1.25rem;
            font-weight: 700;
        }

        #payment-widget {
            margin: 2rem 0;
        }

        #agreement {
            margin: 2rem 0;
        }

        .payment-button {
            width: 100%;
            padding: 1rem;
            font-size: 1.125rem;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 2rem;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <div id="header-container"></div>

    <!-- Main Content -->
    <main class="main-content" style="padding-top: 120px; padding-bottom: 4rem;">
        <div class="checkout-container">
            <h1 style="margin-bottom: 2rem;">결제하기</h1>

            <!-- Order Summary -->
            <div class="order-summary" id="order-summary">
                <h2 style="margin-bottom: 1rem;">주문 내역</h2>
                <div id="order-items">
                    <!-- Will be populated by JavaScript -->
                </div>
                <div class="order-total">
                    <span>총 결제금액</span>
                    <span id="total-amount">0원</span>
                </div>
            </div>

            <!-- Payment Widget -->
            <div id="payment-widget">
                <div class="loading">
                    <p>결제 정보를 불러오는 중...</p>
                </div>
            </div>

            <!-- Agreement -->
            <div id="agreement">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-bottom: 1rem;">
                    <input type="checkbox" id="agree-payment" required>
                    <span>결제 진행 시 결제대행 서비스 약관 및 개인정보 처리방침에 동의합니다.</span>
                </label>
            </div>

            <!-- Payment Button -->
            <button id="payment-button" class="btn btn-primary payment-button" disabled>
                결제하기
            </button>
        </div>
    </main>

    <!-- Footer -->
    <div id="footer-container"></div>

    <!-- Scripts -->
    <script src="../../js/components.js"></script>
    <script src="../../js/main.js"></script>

    <script>
        let orderId = null;
        let amount = 0;
        let orderName = '';
        let customerKey = '';
        let paymentWidget = null;

        $(document).ready(function () {
            // Get order data from URL or localStorage
            const urlParams = new URLSearchParams(window.location.search);
            orderId = urlParams.get('orderId');
            amount = parseInt(urlParams.get('amount') || '0');
            orderName = urlParams.get('orderName') || '강의 신청';

            // Get customer key from localStorage
            const userEmail = localStorage.getItem('userEmail');
            customerKey = userEmail || 'guest-' + Date.now();

            if (!orderId || !amount) {
                // Try to get from localStorage (from apply page)
                const orderData = localStorage.getItem('pendingOrder');
                if (orderData) {
                    const order = JSON.parse(orderData);
                    orderId = order.orderId;
                    amount = order.amount;
                    orderName = order.orderName || '강의 신청';
                } else {
                    alert('주문 정보가 없습니다. 신청 페이지로 이동합니다.');
                    window.location.href = '../apply.html';
                    return;
                }
            }

            // Display order summary
            displayOrderSummary();

            // Initialize payment
            initializePayment();
        });

        function displayOrderSummary() {
            const $items = $('#order-items');
            $items.html(`
                <div class="order-item">
                    <span>${orderName}</span>
                    <span>${amount.toLocaleString('ko-KR')}원</span>
                </div>
            `);
            $('#total-amount').text(amount.toLocaleString('ko-KR') + '원');
        }

        async function initializePayment() {
            try {
                // Get client key from server (Mock for Static Site)
                let clientKey = 'test_ck_D5GePWvyJnrK0W0k6q8gLzN97Eoq'; // Default test key

                try {
                    const keyResponse = await fetch('/api/payments/client-key');
                    if (keyResponse.ok) {
                        const keyData = await keyResponse.json();
                        if (keyData.clientKey) clientKey = keyData.clientKey;
                    }
                } catch (e) {
                    console.warn('⚠️ [Checkout] Failed to fetch client key, using default test key');
                }

                if (!clientKey || clientKey === '') {
                    throw new Error('클라이언트 키를 가져올 수 없습니다.');
                }

                // Initialize Toss Payments Widget
                paymentWidget = PaymentWidget(clientKey, customerKey);

                // Render payment methods
                await paymentWidget.renderPaymentMethods('#payment-widget', amount);

                // Enable payment button
                $('#payment-button').prop('disabled', false).text('결제하기');

            } catch (error) {
                console.error('Payment initialization error:', error);
                $('#payment-widget').html(`
                    <div class="card" style="padding: 2rem; text-align: center;">
                        <p style="color: #ef4444;">결제 시스템 초기화 중 오류가 발생했습니다.</p>
                        <button class="btn btn-outline" onclick="location.reload()">다시 시도</button>
                    </div>
                `);
            }
        }

        $('#payment-button').on('click', async function () {
            if (!$('#agree-payment').is(':checked')) {
                alert('결제 약관에 동의해주세요.');
                return;
            }

            const $btn = $(this);
            $btn.prop('disabled', true).text('결제 진행 중...');

            try {
                // Request payment
                await paymentWidget.requestPayment({
                    orderId: orderId,
                    orderName: orderName,
                    successUrl: window.location.origin + '/html/pay/success.html',
                    failUrl: window.location.origin + '/html/pay/fail.html',
                });
            } catch (error) {
                console.error('Payment request error:', error);
                alert('결제 요청 중 오류가 발생했습니다: ' + (error.message || '알 수 없는 오류'));
                $btn.prop('disabled', false).text('결제하기');
            }
        });
    </script>
</body>

</html>